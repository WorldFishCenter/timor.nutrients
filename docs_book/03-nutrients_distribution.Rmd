# Nutrients distribution {#distribution}

This section presents the analyses that illustrates the distribution of nutrients within various components of small-scale fisheries in East Timor.

## Fish groups 

```{r echo=FALSE, fig.height=8, fig.width=7, message=FALSE, warning=FALSE, out.width='80%', fig.cap="The bar chart illustrates the contribution of a variety of marine food sources to the Recommended Nutrient Intake (RNI) for six fundamental nutrients, based on a 100g portion. The x-axis represents the proportion of RNI fulfilled, with the 100% benchmark signifying the complete RNI for an adult woman of reproductive age. Each bar is a color-segmented stacked visual, with distinct hues corresponding to individual nutrients, and white numbers within indicating the specific percentage contribution of each nutrient. The chart incorporates the total annual catch in metric tons for each marine species from 2018 to 2023, presented at the end of each bar, providing a view of both the nutritional value and the harvest volume of these essential food sources. The transparency of these values is adjusted to reflect each species' relative contribution to the overall catch"}

library(ggplot2)
library(ggforce)

catch_groups_name <-
  timor.nutrients::catch_groups %>%
  dplyr::select(
    grouped_taxa = interagency_code,
    catch_name
  )

tot_catch <-
  timor.nutrients::region_stats %>%
  dplyr::group_by(grouped_taxa) %>%
  dplyr::summarise(catch = sum(catch)) %>%
  dplyr::left_join(catch_groups_name) %>%
  dplyr::select(-grouped_taxa) %>%
  dplyr::select(catch_name, catch) %>%
  dplyr::mutate(catch = catch / 1000)

base_plot <-
  timor.nutrients::nutrients_table %>%
  dplyr::left_join(catch_groups_name) %>%
  dplyr::select(catch_name, Selenium_mu:Vitamin_A_mu) %>%
  rename_nutrients_mu(hyphen = FALSE) %>%
  tidyr::pivot_longer(-catch_name, names_to = "nutrient", values_to = "concentration") %>%
  dplyr::filter(!nutrient == "selenium" & !catch_name %in% "Other") %>%
  dplyr::left_join(RDI_tab) %>%
  dplyr::mutate(
    nutrient = stringr::str_to_title(nutrient),
    nutrient = dplyr::case_when(
      nutrient == "Omega3" ~ "Omega-3",
      nutrient == "Vitamina" ~ "Vitamin-A",
      TRUE ~ nutrient
    )
  ) %>%
  dplyr::mutate(rdi = (concentration * 100) / conv_factor) %>%
  dplyr::group_by(catch_name) %>%
  dplyr::mutate(tot = sum(rdi, na.rm = T)) %>%
  dplyr::arrange(-tot) %>%
  dplyr::left_join(tot_catch) %>%
  tidyr::replace_na(list(catch = 0))

tot_catch_plot <-
  base_plot %>%
  dplyr::group_by(catch_name) %>% # Added .drop false to ensure that all factor levels remain in plot
  dplyr::summarise(
    catch = dplyr::first(catch),
    tot = dplyr::first(tot)
  )


ggplot2::ggplot() +
  ggplot2::theme_minimal() +
  ggplot2::geom_col(base_plot, mapping = ggplot2::aes(rdi, reorder(catch_name, tot), fill = nutrient), alpha = 0.85) +
  geom_text(base_plot,
    mapping = aes(rdi, reorder(catch_name, tot), label = round(rdi, 2) * 100),
    position = position_stack(0.5),
    color = "white",
    size = 3,
    inherit.aes = FALSE
  ) +
  geom_text(tot_catch_plot,
    mapping = aes(tot, reorder(catch_name, tot),
      label = scales::comma(round(catch, 0), suffix = " t"),
      alpha = catch
    ),
    size = 4,
    nudge_x = 0.1
  ) +
  ggplot2::scale_fill_manual(values = timor.nutrients::palettes$nutrients_palette) +
  ggplot2::scale_color_viridis_c() +
  ggplot2::scale_x_continuous(labels = scales::percent, n.breaks = 10) +
  ggplot2::labs(y = "", x = "Matched RNI from 100g portion", fill = "") +
  ggplot2::theme(legend.position = "bottom") +
  coord_cartesian(expand =  FALSE, xlim = c(0, 1.55)) +
  guides(alpha = "none")

```


```{r echo=FALSE, fig.height=8, fig.width=7, message=FALSE, warning=FALSE, out.width='80%', fig.cap="Distribution of nutritional content among different fish groups. This series of bar graphs delineates the contribution of various fish groups to the total nutrient stock, highlighting the top ten fish groups for calcium, omega-3, iron, protein, vitamin A, and zinc. Each graph is ordered to reflect the descending contribution of each fish group relative to each nutrient."}

timor.nutrients::region_stats %>%
  dplyr::group_by(grouped_taxa) %>%
  dplyr::summarise(dplyr::across(dplyr::where(is.numeric), ~ sum(.x, na.rm = T))) %>%
  tidyr::pivot_longer(-c(grouped_taxa, catch), names_to = "nutrient") %>%
  dplyr::group_by(nutrient, grouped_taxa) %>%
  dplyr::summarise(value = sum(value)) %>%
  dplyr::arrange(-value, .by_group = TRUE) %>%
  dplyr::slice_head(n = 10) %>%
  dplyr::left_join(catch_groups_name) %>%
  dplyr::select(-grouped_taxa) %>%
  dplyr::select(catch_name, nutrient, value) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    nutrient = as.factor(nutrient),
    catch_name = tidytext::reorder_within(catch_name, value, nutrient)
  ) %>%
  dplyr::filter(!nutrient == "selenium") %>%
  dplyr::mutate(
    nutrient = stringr::str_to_title(nutrient),
    nutrient = dplyr::case_when(
      nutrient == "Omega3" ~ "Omega-3",
      nutrient == "Vitamina" ~ "Vitamin-A",
      TRUE ~ nutrient
    )
  ) %>%
  ggplot(aes(value / 1000, catch_name, fill = nutrient)) +
  theme_minimal() +
  geom_col(alpha = 0.85) +
  facet_wrap(. ~ nutrient, ncol = 2, scales = "free") +
  tidytext::scale_y_reordered() +
  labs(x = "tons", y = "") +
  theme(legend.position = "") +
  scale_fill_manual(values = timor.nutrients::palettes$nutrients_palette)
```

## Habitat and gear type

```{r echo=FALSE, fig.height=8, fig.width=7, message=FALSE, warning=FALSE, fig.cap="Sankey diagram showing the relative distribution of key nutrients across various marine habitats and the corresponding extraction by different fishing gear types used in Timor-Est small-scale fisheries."}
parallel_plot <-
  timor.nutrients::kobo_trips %>%
  dplyr::select(habitat, gear_type, Selenium_mu:Vitamin_A_mu) %>%
  rename_nutrients_mu() %>%
  tidyr::pivot_longer(-c(habitat, gear_type), names_to = "nutrient", values_to = "concentration_g") %>%
  dplyr::group_by(habitat, gear_type, nutrient) %>%
  dplyr::summarise(concentration_g = sum(concentration_g, na.rm = T)) %>%
  # get relative values
  dplyr::group_by(nutrient) %>%
  dplyr::mutate(
    nutrient_sum = sum(concentration_g),
    concentration_g = concentration_g / nutrient_sum * 100
  ) %>%
  dplyr::ungroup() %>%
  # dplyr::mutate(concentration_g = dplyr::case_when(
  #  nutrient == "calcium" ~ concentration_g * 1000,
  #  nutrient == "iron" ~ concentration_g * 1000,
  #  nutrient == "omega3" ~ concentration_g * 1,
  #  nutrient == "protein" ~ concentration_g * 1,
  #  nutrient == "selenium" ~ concentration_g * 1000000,
  #  nutrient == "vitaminA" ~ concentration_g * 1000000,
  #  nutrient == "zinc" ~ concentration_g * 1000,
  #  TRUE ~ concentration_g
  # )) %>%
  dplyr::mutate(dplyr::across(habitat:nutrient, ~ as.factor(.x))) %>%
  dplyr::mutate(
    nutrient = as.factor(nutrient)
  ) %>%
  dplyr::mutate(
    nutrient = stringr::str_to_title(nutrient),
    nutrient = dplyr::case_when(
      nutrient == "Omega3" ~ "Omega-3",
      nutrient == "Vitamina" ~ "Vitamin-A",
      TRUE ~ nutrient
    )
  ) %>%
  dplyr::rename(
    "Nutrient" = nutrient,
    "Habitat" = habitat,
    "Gear type" = gear_type
  ) %>%
  ggforce::gather_set_data(c(3, 1, 2))

parallel_plot$x <- factor(parallel_plot$x,
  levels = c("3", "1", "2"),
  labels = c("Nutrient", "Habitat", "Gear type")
)

parallel_plot$y <- factor(parallel_plot$y, levels = c(
  "Protein", "Omega-3", "Calcium", "Iron", "Vitamin-A", "Zinc", "Selenium",
  "Deep", "Reef", "FAD", "Beach", "Traditional FAD", "Mangrove", "Seagrass",
  "gill net", "long line", "hand line", "seine net", "spear gun", "manual collection",
  "beach seine", "cast net", "trap"
))

parallel_plot %>%
  dplyr::filter(!Nutrient == "Selenium") %>%
  na.omit() %>%
  ggplot(aes(x, id = id, split = y, value = concentration_g)) +
  ggforce::geom_parallel_sets(aes(fill = Nutrient), alpha = 0.7, axis.width = 0.1) +
  ggforce::geom_parallel_sets_axes(axis.width = 0.25, fill = "grey95") +
  ggforce::geom_parallel_sets_labels(colour = "grey30", angle = 0, size = 3.5) +
  scale_x_discrete(name = NULL, expand = c(0, 0.2)) +
  scale_y_continuous(breaks = NULL, expand = c(0.05, 0)) +
  theme_minimal(12) +
  scale_fill_manual(values = timor.nutrients::palettes$nutrients_palette) +
  # scale_fill_manual(values = c("#508AA8", "grey95", "#BD9391")) +
  theme(
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    axis.text = element_text(size = 12, color = "black")
  ) +
  labs(fill = "")
```
